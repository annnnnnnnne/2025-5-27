var isCallBackTage = false;
var latestIndex = 0;

function CreateTabs(treeContent, tabContent, tabsMenu, url) {
    var trees = "#" + treeContent;
    var tabs = "#" + tabContent;
    var tabsMenus = "#" + tabsMenu;
    var obj = GetUrlQueryParamsObj(url);
    p.get(url, obj, function (data) {
        $(trees).tree({
            data: data,
            lines: true,
            onClick: function (node) {
                if (node.attributes) {
                    if (node.attributes.url) {
                        var isIframe = false;
                        if (node.iFrame) {
                            if (node.iFrame == "true") {
                                isIframe = true;
                            }
                        }
                        openTab(node.text, node.attributes.url, tabs, isIframe);
                    }
                }
            }
        });
    });

    //绑定tabs的右键菜单
    $(tabs).tabs({
        fit: true,
        border: false,
        onContextMenu: function (e, title) {
            e.preventDefault();
            $(tabsMenus).menu('show', {
                left: e.pageX,
                top: e.pageY
            }).data("tabTitle", title);
        }
        , onClose: function (title, index) {
            if (latestIndex) {
                $(tabs).tabs('select', latestIndex);
                latestIndex--;
            }
            else {
                --index;
                if (index < 0) index = 0;
                $(tabs).tabs('select', index);
            }
        }
    });

    //实例化menu的onClick事件
    $(tabsMenus).menu({
        onClick: function (item) {
            CloseTab(this, item.name, tabs);
        }
    });
}

function OnlyCreateTabs(tabContent, tabsMenu) {
    var tabs = "#" + tabContent;
    var tabsMenus = "#" + tabsMenu;

    //绑定tabs的右键菜单
    $(tabs).tabs({
        fit: true,
        border: false,
        onContextMenu: function (e, title) {
            e.preventDefault();
            $(tabsMenus).menu('show', {
                left: e.pageX,
                top: e.pageY
            }).data("tabTitle", title);
        }, onClose: function (title, index) {
            if (latestIndex) {
                $(tabs).tabs('select', latestIndex);
                latestIndex--;
            }
            else {
                --index;
                if (index < 0) index = 0;
                $(tabs).tabs('select', index);
            }
        }
    });

    //实例化menu的onClick事件
    $(tabsMenus).menu({
        onClick: function (item) {
            CloseTab(this, item.name, tabs);
        }
    });
}

function openTab(title, url, tabContent, IsFrame, IsReload, hasCallBack,opt) {

    opt = $.extend(true, {
        closable: true,
        closed: true
    }, opt);

    title = unescape(title);

    if ($(tabContent).tabs('exists', title)) {
        $(tabContent).tabs('select', title);

        if (IsReload) {
            var tab = $(tabContent).tabs('getTab', title),
                frames = tab.find('iframe');
            if (frames.length > 0) {
                frames[0].src = 'about:blank';
                frames[0].src = url;
            }
        }
    } else {

        var tabIndex = $(tabContent).tabs('getSelected');
        latestIndex = $(tabContent).tabs('getTabIndex', tabIndex);

        //if (url.indexOf("?") > -1) {
        //    url += '&rand=' + Date.parse(new Date());
        //} else {
        //    url += '?rand=' + Date.parse(new Date());
        //}

        //url += '&';
        if (IsFrame || ((url.indexOf("http:") == 0) || (url.indexOf("https:") == 0))) {
            var height = $(tabContent).parent().height() - 45;
            //var height = $(tabContent).find('div.tabs-panels.tabs-panels-noborder').height() - 3;
            var content = '<iframe scrolling="auto" frameborder="0"  src="Jmp.aspx?url=' + escape(url) + '&rand=' + Date.parse(new Date()) + '" style="width:100%;height:' + height + 'px;overflow-x:hidden"></iframe>';



            $(tabContent).tabs('add', {
                title: title,
                content: content,
                closable: opt.closable,
                closed: opt.closed,
                cache: true,
                //iconCls: "tabs-btn-ico-iframe"
            });

            if (hasCallBack & !isCallBackTage) {
                $(tabContent).tabs({
                    onSelect: function (title, index) {
                        var nowTab = $(tabContent).tabs("getSelected");
                        var iframe = $(nowTab).find("iframe");
                        if (iframe) {
                            strCallBackName = "try{tabCallBack();}catch(e){}";
                            p.eval(strCallBackName, iframe.get(0).contentWindow.window);
                        }
                    }
                });
                isCallBackTage = true;
            }

        } else {
            $(tabContent).tabs('add', {
                title: title,
                href: url,
                closable: opt.closable,
                closed: opt.closed,
                cache: true
                //iconCls: "tabs-btn-ico-url"
            });

            //if (hasCallBack) {
            //    $(tabContent).tabs({
            //        onSelect: function (title, index) {
            //            var nowTab = $(tabContent).tabs("'getSelected'");
            //            debugger;
            //        }
            //    });
            //}
        }
    }
}

function openTabEx(title, url, tabContent, IsFrame) {
    var tabs = "#" + tabContent;
    openTab(title, url, tabs, IsFrame);
}


function creatTabex(tabContent, url, index) {
    if ((typeof (index) == typeof (undefined)) || (index == null)) {
        index = 0;
    }
    var tabex = "#" + tabContent;
    var obj01 = GetUrlQueryParamsObj(url);
    p.get(url, obj01, function (data) {
        var t;
        $.each(data._Items, function (i, o) {
            var r = "";
            if (i == index) {
                t = this.text;
                r = this.attributes.url;
            }
            var isIframe = false;
            if (this.iFrame) {
                if (this.iFrame == "true") {
                    isIframe = true;
                }
            }
            open_tobex(this.text, r, this.attributes.url, tabex, isIframe);
        });
        $(tabex).tabsex({
            onSelect: function (title, index) {
                var target = this;
                var tab = $(target).tabsex('getTab', index);
                var pp = tab.panel("options");
                if (pp.isIframe) {
                    var content = $(pp).attr("content");
                    if (!pp.isLoaded) {
                        $(target).tabsex('update', { tab: tab, options: { content: $(content).attr("src", pp.upUrl), isLoaded: true } });
                    }
                } else {
                    if (pp.href == "") {
                        $(target).tabsex('update', { tab: tab, options: { href: pp.upUrl } });
                    }
                }
            }
        });
    });
}

function open_tobex(title, url, upUrl, tabContent, IsFrame) {

    if ($(tabContent).tabsex('exists', title)) {
        $(tabContent).tabsex('select', title);
    } else {

        if (IsFrame || ((url.indexOf("http:") == 0) || (url.indexOf("https:") == 0))) {
            var contentHeight = 35;
            if (typeof (getTabContentHeight) !== typeof (undefined)) {
                contentHeight = getTabContentHeight();
            }
            var height = $(tabContent).parent().height() - contentHeight;

            var content = '<iframe scrolling="auto" frameborder="0"  src="' + url + '" style="width:100%;height:' + height + 'px;"></iframe>';
            $(tabContent).tabsex('add', {
                title: title,
                upUrl: upUrl,
                selected: url != "",
                content: content,
                cache: true,
                isIframe: true
            });
        } else {

            $(tabContent).tabsex('add', {
                title: title,
                upUrl: upUrl,
                href: url,
                selected: url != "",
                cache: true
            });
        }
    }
}

//几个关闭事件的实现
function CloseTab(menu, type, tabContent) {
    var curTabTitle = $(menu).data("tabTitle");
    var tabs = $(tabContent);

    var currentTab = $(tabContent).tabs("getTab", curTabTitle);
    var closable = false;

    if (currentTab) {
        closable = currentTab.panel('options').closable;
    }

    if (type === "close" && closable) {
        tabs.tabs("close", curTabTitle);
        return;
    }

    var allTabs = tabs.tabs("tabs");
    var closeTabsTitle = [];

    $.each(allTabs, function () {
        var opt = $(this).panel("options");
        if (opt.closable && opt.title != curTabTitle && type === "Other") {
            closeTabsTitle.push(opt.title);
        } else if (opt.closable && type === "All") {
            closeTabsTitle.push(opt.title);
        }
    });

    for (var i = 0; i < closeTabsTitle.length; i++) {
        tabs.tabs("close", closeTabsTitle[i]);
    }
}

function GetUrlQueryParamsObj(url) {
    var queryStrings = '';
    var num = url.indexOf("?");
    if (num > -1)
        queryStrings = url.substr(num + 1);
    var arr = queryStrings.split("&");
    var obj = {};
    for (let i = 0; i < arr.length; i++) {
        num = arr[i].indexOf("=");
        if (num > -1) {
            name = arr[i].substring(0, num);
            value = arr[i].substr(num + 1);
            obj[name] = value;
        }
    }
    return obj;
}